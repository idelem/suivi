<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi</title>
    <style>
        /* Minimal CSS inspired by Emacs tao-theme */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            background: #fefefe;
            color: #2e2e2e;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            width: 300vw;
            height: 100vh;
            transition: transform 0.3s ease;
        }

        .view {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #d0d0d0;
            overflow: hidden; /* Add this */
        }

        .header {
            padding: 10px;
            border-bottom: 1px solid #d0d0d0;
            background: #f8f8f8;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn, .home-btn {
            background: none;
            border: 1px solid #ccc;
            padding: 4px 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
        }

        .back-btn:hover, .home-btn:hover {
            background: #eee;
        }

        .back-btn:disabled, .home-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .retweet-count {
            background: #e8e8e8;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }

        .timeline {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .note {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            background: #fdfdfd;
            cursor: pointer;
        }

        .note:hover {
            background: #f5f5f5;
        }

        .note.selected {
            background: #e6f3ff;
            border-color: #4a9eff;
        }

        .select-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 2px solid #ccc;
            margin-right: 10px;
            margin-top: 3px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .select-dot.selected {
            background: #4a9eff;
            border-color: #4a9eff;
        }

        .note-content {
            flex: 1;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .note-nav {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex-shrink: 0;
        }

        .nav-btn {
            width: 16px;
            height: 16px;
            border: 1px solid #ccc;
            background: none;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: #eee;
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .compose-area {
            border-top: 1px solid #d0d0d0;
            background: #f8f8f8;
            padding: 10px;
            position: sticky;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 10;
        }

        .compose-input {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            border: 1px solid #ccc;
            font-family: inherit;
            font-size: inherit;
            resize: vertical;
            margin-bottom: 8px;
        }

        .compose-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .compose-btn {
            padding: 6px 12px;
            border: 1px solid #ccc;
            background: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
        }

        .compose-btn:hover {
            background: #eee;
        }

        .compose-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .selected-count {
            font-size: 11px;
            color: #666;
        }

        .editing .note-content {
            display: none;
        }

        .edit-input {
            flex: 1;
            margin-right: 10px;
            padding: 4px;
            border: 1px solid #4a9eff;
            font-family: inherit;
            font-size: inherit;
        }

        .view-title {
            font-size: 12px;
            color: #666;
        }

        /* Add thumbnail styles */
        .repost-thumbnails {
            display: flex;
            gap: 4px;
            margin-top: 6px;
            margin-bottom: 2px;
        }
        .repost-thumb {
            width: 32px;
            height: 32px;
            background: #e6f3ff;
            border: 1px solid #4a9eff;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #2e2e2e;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .repost-thumb:hover {
            background: #d0e7ff;
        }

        .delete-btn {
            background: #ffeded;
            border: 1px solid #ff4a4a;
            color: #c00;
            font-weight: bold;
        }
        .delete-btn:hover {
            background: #ffcccc;
            border-color: #ff0000;
            color: #900;
        }

        /* Responsive: ensure compose-area is always visible on mobile */
        @media (max-width: 600px) {
            .compose-area {
                padding-bottom: env(safe-area-inset-bottom, 10px);
            }
        }
    </style>
</head>
<body>
    <div class="app-container" id="appContainer">
        <!-- Center view: main timeline -->
        <div class="view">
            <div class="header">
                <button class="home-btn" id="mainHomeBtn" style="visibility: hidden;">üè†</button>
                <span class="view-title">Timeline</span>
                <button class="compose-btn delete-btn" id="mainDeleteBtn" style="display:none; margin-left:auto;">Delete</button>
            </div>
            <div class="search-area" style="padding:10px; border-bottom:1px solid #eee;">
                <input type="text" id="mainSearchInput" class="compose-input" placeholder="Search notes..." style="min-height:32px; margin-bottom:0;">
            </div>
            <div class="timeline" id="mainTimeline"></div>
            <div class="compose-area">
                <textarea class="compose-input" id="mainComposeInput" placeholder="Compose a new note..."></textarea>
                <div class="compose-controls">
                    <button class="compose-btn" id="mainComposeBtn">Post</button>
                    <button class="compose-btn" id="mainClearBtn">Clear Selection</button>
                    <span class="selected-count" id="mainSelectedCount">0 selected</span>
                </div>
            </div>
        </div>

        <!-- Right view: notes retweeting this note -->
        <div class="view">
            <div class="header">
                <button class="back-btn" id="rightBackBtn">‚Üê</button>
                <button class="home-btn" id="rightHomeBtn">üè†</button>
                <span class="view-title">Retweeted by</span>
                <span class="retweet-count" id="retweetCount">0</span>
                <button class="compose-btn delete-btn" id="rightDeleteBtn" style="display:none; margin-left:auto;">Delete</button>
            </div>
            <div class="timeline" id="rightTimeline"></div>
            <div class="compose-area">
                <textarea class="compose-input" id="rightComposeInput" placeholder="Compose a new note..."></textarea>
                <div class="compose-controls">
                    <button class="compose-btn" id="rightComposeBtn">Post</button>
                    <button class="compose-btn" id="rightClearBtn">Clear Selection</button>
                    <span class="selected-count" id="rightSelectedCount">0 selected</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage (now using localStorage)
        let notes = [];
        let nextId = 1;
        let selectedNotes = new Set();
        let currentView = 'main';
        let viewHistory = [];
        let currentNoteId = null;
        let editingNoteId = null;

        // --- LocalStorage helpers ---
        function saveToStorage() {
            localStorage.setItem('suivi_notes', JSON.stringify(notes));
            localStorage.setItem('suivi_nextId', nextId);
        }

        function loadFromStorage() {
            const notesStr = localStorage.getItem('suivi_notes');
            const nextIdStr = localStorage.getItem('suivi_nextId');
            notes = notesStr ? JSON.parse(notesStr) : [];
            nextId = nextIdStr ? parseInt(nextIdStr, 10) : 1;
        }

        // Note structure: { id, content, retweets: [noteId], retweetedBy: [noteId] }

        function createNote(content, retweets = []) {
            const note = {
                id: nextId++,
                content: content.trim(),
                retweets: [...retweets],
                retweetedBy: []
            };

            // Update retweeted notes
            retweets.forEach(retweetId => {
                const retweetedNote = notes.find(n => n.id === retweetId);
                if (retweetedNote) {
                    retweetedNote.retweetedBy.push(note.id);
                }
            });

            notes.push(note);
            saveToStorage();
            return note;
        }

        function renderNote(note, timelineId) {
            const noteEl = document.createElement('div');
            noteEl.className = 'note';
            noteEl.dataset.noteId = note.id;

            if (selectedNotes.has(note.id)) {
                noteEl.classList.add('selected');
            }

            if (editingNoteId === note.id) {
                noteEl.classList.add('editing');
            }

            const selectDot = document.createElement('div');
            selectDot.className = 'select-dot';
            if (selectedNotes.has(note.id)) {
                selectDot.classList.add('selected');
            }

            const content = document.createElement('div');
            content.className = 'note-content';
            content.textContent = note.content;

            const editInput = document.createElement('input');
            editInput.type = 'text';
            editInput.className = 'edit-input';
            editInput.value = note.content;
            editInput.style.display = editingNoteId === note.id ? 'block' : 'none';

            // --- Repost thumbnails ---
            let repostThumbs = null;
            if (note.retweets && note.retweets.length > 0) {
                repostThumbs = document.createElement('div');
                repostThumbs.className = 'repost-thumbnails';
                note.retweets.forEach(retweetId => {
                    const repostNote = notes.find(n => n.id === retweetId);
                    if (repostNote) {
                        const thumb = document.createElement('div');
                        thumb.className = 'repost-thumb';
                        thumb.title = repostNote.content;
                        // Show first 10 chars or note id
                        thumb.textContent = repostNote.content.slice(0, 10) || `#${repostNote.id}`;
                        thumb.addEventListener('click', (e) => {
                            e.stopPropagation();
                            // Scroll to the reposted note in the main timeline
                            goHome();
                            setTimeout(() => {
                                const el = document.querySelector(`[data-note-id="${repostNote.id}"]`);
                                if (el) {
                                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    el.classList.add('selected');
                                    setTimeout(() => el.classList.remove('selected'), 800);
                                }
                            }, 100);
                        });
                        repostThumbs.appendChild(thumb);
                    }
                });
            }

            const navBtns = document.createElement('div');
            navBtns.className = 'note-nav';

            // Remove leftBtn (retweets navigation)
            // Only keep rightBtn (retweetedBy navigation)
            const rightBtn = document.createElement('button');
            rightBtn.className = 'nav-btn';
            rightBtn.textContent = note.retweetedBy.length.toString();
            rightBtn.disabled = note.retweetedBy.length === 0;
            rightBtn.title = `Retweeted by ${note.retweetedBy.length}`;

            navBtns.appendChild(rightBtn);

            // Event listeners
            selectDot.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleSelection(note.id);
            });

            content.addEventListener('click', (e) => {
                e.stopPropagation();
                startEditing(note.id);
            });

            rightBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (note.retweetedBy.length > 0) {
                    navigateToRetweetedBy(note.id);
                }
            });

            editInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveEdit(note.id, editInput.value);
                } else if (e.key === 'Escape') {
                    cancelEdit();
                }
            });

            editInput.addEventListener('blur', () => {
                saveEdit(note.id, editInput.value);
            });

            noteEl.appendChild(selectDot);
            noteEl.appendChild(content);
            if (repostThumbs) noteEl.appendChild(repostThumbs);
            noteEl.appendChild(editInput);
            noteEl.appendChild(navBtns);

            return noteEl;
        }

        let searchKeyword = "";

        // --- Search/filter logic ---
        const searchInput = document.getElementById('mainSearchInput');
        searchInput.addEventListener('input', function () {
            searchKeyword = this.value.trim();
            renderTimeline('mainTimeline');
        });
        searchInput.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                this.value = '';
                searchKeyword = '';
                renderTimeline('mainTimeline');
                this.blur();
            }
        });

        // --- Modify renderTimeline to filter by search ---
        function renderTimeline(timelineId, noteIds = null) {
            const timeline = document.getElementById(timelineId);
            timeline.innerHTML = '';

            let notesToShow;
            if (noteIds) {
                notesToShow = noteIds.map(id => notes.find(n => n.id === id)).filter(n => n);
            } else {
                notesToShow = [...notes];
            }

            // Filter by search keyword if present
            if (timelineId === 'mainTimeline' && searchKeyword) {
                const kw = searchKeyword.toLowerCase();
                notesToShow = notesToShow.filter(note => note.content.toLowerCase().includes(kw));
            }

            // Sort by ID (newest first)
            notesToShow.sort((a, b) => b.id - a.id);

            notesToShow.forEach(note => {
                timeline.appendChild(renderNote(note, timelineId));
            });
        }

        // Optional: clear search when switching views or after posting
        function clearSearch() {
            searchInput.value = '';
            searchKeyword = '';
            renderTimeline('mainTimeline');
        }

        // Example: clear search after posting a note
        function composeNote(content, viewType) {
            if (!content.trim()) return;

            const retweets = Array.from(selectedNotes);
            createNote(content, retweets);
            clearSelection();
            clearComposeInputs();

            // Always re-render all timelines to ensure consistency
            renderTimeline('mainTimeline');
            if (currentView === 'right' && currentNoteId) {
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    renderTimeline('rightTimeline', note.retweetedBy);
                }
            }
            updateSelectedCounts();
            clearSearch(); // clear search after posting
        }

        function toggleSelection(noteId) {
            if (selectedNotes.has(noteId)) {
                selectedNotes.delete(noteId);
            } else {
                selectedNotes.add(noteId);
            }
            updateUI();
        }

        function clearSelection() {
            selectedNotes.clear();
            updateUI();
        }

        function startEditing(noteId) {
            editingNoteId = noteId;
            updateUI();
            // Focus the edit input
            setTimeout(() => {
                const editInput = document.querySelector(`[data-note-id="${noteId}"] .edit-input`);
                if (editInput) {
                    editInput.focus();
                    editInput.select();
                }
            }, 0);
        }

        function saveEdit(noteId, newContent) {
            const note = notes.find(n => n.id === noteId);
            if (note && newContent.trim()) {
                note.content = newContent.trim();
                saveToStorage();
            }
            cancelEdit();
        }

        function cancelEdit() {
            editingNoteId = null;
            updateUI();
        }

        function composeNote(content, viewType) {
            if (!content.trim()) return;

            const retweets = Array.from(selectedNotes);
            createNote(content, retweets);
            clearSelection();
            clearComposeInputs();

            // Always re-render all timelines to ensure consistency
            renderTimeline('mainTimeline');
            if (currentView === 'right' && currentNoteId) {
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    renderTimeline('rightTimeline', note.retweetedBy);
                }
            }
            updateSelectedCounts();
            clearSearch(); // clear search after posting
        }

        function clearComposeInputs() {
            document.querySelectorAll('.compose-input').forEach(input => {
                input.value = '';
            });
        }

        function navigateToRetweets(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note || note.retweets.length === 0) return;

            viewHistory.push({ view: currentView, noteId: currentNoteId });
            currentView = 'left';
            currentNoteId = noteId;
            slideToView('left');
            renderTimeline('leftTimeline', note.retweets);
        }

        function navigateToRetweetedBy(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note || note.retweetedBy.length === 0) return;

            viewHistory.push({ view: currentView, noteId: currentNoteId });
            currentView = 'right';
            currentNoteId = noteId;
            slideToView('right');
            renderTimeline('rightTimeline', note.retweetedBy);
            document.getElementById('retweetCount').textContent = note.retweetedBy.length;
        }

        function goBack() {
            if (viewHistory.length === 0) return;

            const previous = viewHistory.pop();
            currentView = previous.view;
            currentNoteId = previous.noteId;
            slideToView(currentView);

            // Re-render the timeline we're going back to
            if (currentView === 'main') {
                renderTimeline('mainTimeline');
            } else if (currentView === 'left' && currentNoteId) {
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    renderTimeline('leftTimeline', note.retweets);
                }
            } else if (currentView === 'right' && currentNoteId) {
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    renderTimeline('rightTimeline', note.retweetedBy);
                    document.getElementById('retweetCount').textContent = note.retweetedBy.length;
                }
            }
        }

        function goHome() {
            viewHistory = [];
            currentView = 'main';
            currentNoteId = null;
            slideToView('main');
            renderTimeline('mainTimeline');
        }

        function slideToView(view) {
            const container = document.getElementById('appContainer');
            let translateX;
            switch (view) {
                case 'main': translateX = 0; break;
                case 'right': translateX = -100; break;
            }
            container.style.transform = `translateX(${translateX}vw)`;

            // Update back button state
            document.getElementById('rightBackBtn').disabled = viewHistory.length === 0;
        }

        function updateSelectedCounts() {
            const count = selectedNotes.size;
            const text = count === 1 ? '1 selected' : `${count} selected`;
            document.getElementById('mainSelectedCount').textContent = text;
            document.getElementById('rightSelectedCount').textContent = text;

            // Show/hide delete buttons in headers
            document.getElementById('mainDeleteBtn').style.display = count > 0 ? '' : 'none';
            document.getElementById('rightDeleteBtn').style.display = count > 0 ? '' : 'none';
        }

        function updateUI() {
            // Re-render current timeline
            if (currentView === 'main') {
                renderTimeline('mainTimeline');
            } else if (currentView === 'right' && currentNoteId) {
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    renderTimeline('rightTimeline', note.retweetedBy);
                }
            }
            updateSelectedCounts();
        }

        function deleteSelectedNotes() {
            if (selectedNotes.size === 0) return;
            if (!confirm(`Delete ${selectedNotes.size} selected note(s)? This cannot be undone.`)) return;

            // Remove selected notes and update retweets/retweetedBy references
            notes = notes.filter(note => {
                if (!selectedNotes.has(note.id)) return true;
                // Remove this note from retweetedBy of others
                note.retweets.forEach(retweetId => {
                    const retweetedNote = notes.find(n => n.id === retweetId);
                    if (retweetedNote) {
                        retweetedNote.retweetedBy = retweetedNote.retweetedBy.filter(id => id !== note.id);
                    }
                });
                // Remove this note from retweets of others
                note.retweetedBy.forEach(retweetedById => {
                    const retweeter = notes.find(n => n.id === retweetedById);
                    if (retweeter) {
                        retweeter.retweets = retweeter.retweets.filter(id => id !== note.id);
                    }
                });
                return false;
            });
            selectedNotes.clear();
            saveToStorage();
            updateUI();
        }

        // Event listeners
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (editingNoteId) {
                    cancelEdit();
                } else {
                    clearSelection();
                }
            }
        });

        // Compose buttons
        document.getElementById('mainComposeBtn').addEventListener('click', () => {
            composeNote(document.getElementById('mainComposeInput').value, 'main');
        });
        document.getElementById('rightComposeBtn').addEventListener('click', () => {
            composeNote(document.getElementById('rightComposeInput').value, 'right');
        });

        // Clear selection buttons
        document.getElementById('mainClearBtn').addEventListener('click', clearSelection);
        document.getElementById('rightClearBtn').addEventListener('click', clearSelection);

        // Back buttons
        document.getElementById('rightBackBtn').addEventListener('click', goBack);

        // Home buttons
        document.getElementById('rightHomeBtn').addEventListener('click', goHome);
        document.getElementById('mainHomeBtn').addEventListener('click', goHome);

        // Compose input enter handling
        document.querySelectorAll('.compose-input').forEach(input => {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    const viewType = input.id.includes('main') ? 'main' : 'right';
                    composeNote(input.value, viewType);
                }
            });
        });

        // Add event listeners for delete buttons
        document.getElementById('mainDeleteBtn').addEventListener('click', deleteSelectedNotes);
        document.getElementById('rightDeleteBtn').addEventListener('click', deleteSelectedNotes);

        // Initialize with some sample data or load from storage
        function initializeApp() {
            loadFromStorage();
            if (notes.length === 0) {
                createNote("This is the first note!");
                createNote("Another independent note.");
                createNote("This note retweets the first one.", [1]);
                createNote("This also retweets the first note.", [1]);
                createNote("This retweets the third note.", [3]);
            }
            renderTimeline('mainTimeline');
            slideToView('main');
            updateSelectedCounts();
        }

        initializeApp();
    </script>
</body>
</html>